name: Deploy to AWS EC2

on:
  push:
    branches:
      - main  # Ou 'master', dependendo da sua branch principal

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Baixa o código do repositório
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Configura o Java 17 (igual ao passo 3.2 do seu doc)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. Build do Backend (Spring Boot)
      - name: Build Backend
        run: |
          cd api
          chmod +x mvnw
          ./mvnw -DskipTests clean package

      # 4. Configura Node.js 20 (igual ao passo 3.3 do seu doc)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 5. Build do Frontend (React)
      - name: Build Frontend
        run: |
          cd frontend
          npm install
          npm run build

      # 6. Copia os arquivos para a EC2 via SCP
      - name: Copy files to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "api/target/*.jar,frontend/dist/"
          target: "/home/ubuntu/deploy-temp" # Pasta temporária na EC2

      # 7. Executa comandos na EC2 para atualizar a aplicação
      - name: Execute Remote SSH Commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "=== INICIANDO DEBUG ==="
            
            # 1. Ver o que chegou na pasta temporária
            echo "Listando arquivos que chegaram via SCP:"
            ls -R /home/ubuntu/deploy-temp
            
            echo "---------------------------------"
            
            # 2. Ver data dos arquivos atuais do site (antes de apagar)
            echo "Data dos arquivos atuais no Nginx:"
            ls -l /home/ubuntu/apps/questionario/frontend/dist/index.html || echo "Arquivo index.html não encontrado no destino!"

            echo "---------------------------------"
            echo "Atualizando arquivos..."

            # 3. Parar Backend
            sudo systemctl stop questionario

            # 4. Atualizar Backend (JAR)
            # O '||' garante que vejamos o erro se falhar, mas não trava o script de imediato no debug
            sudo cp /home/ubuntu/deploy-temp/api/target/*.jar /opt/questionario/app.jar || echo "ERRO AO COPIAR JAR"

            # 5. Atualizar Frontend
            # ATENÇÃO: Aqui vamos tentar identificar a pasta correta dinamicamente
            
            # Limpa a pasta destino
            sudo rm -rf /home/ubuntu/apps/questionario/frontend/dist/*
            
            # Tenta copiar. Se a estrutura for deploy-temp/frontend/dist
            if [ -d "/home/ubuntu/deploy-temp/frontend/dist" ]; then
                sudo cp -r /home/ubuntu/deploy-temp/frontend/dist/* /home/ubuntu/apps/questionario/frontend/dist/
                echo "Cópia feita de deploy-temp/frontend/dist"
            
            # Se a estrutura for deploy-temp/dist (sem a pasta frontend)
            elif [ -d "/home/ubuntu/deploy-temp/dist" ]; then
                sudo cp -r /home/ubuntu/deploy-temp/dist/* /home/ubuntu/apps/questionario/frontend/dist/
                echo "Cópia feita de deploy-temp/dist (caminho curto)"
            
            else
                echo "ERRO CRÍTICO: Não encontrei a pasta dist dentro de deploy-temp!"
                ls -R /home/ubuntu/deploy-temp
            fi

            # 6. Reiniciar serviços
            sudo systemctl start questionario
            # Força o Nginx a reler (útil para caches teimosos)
            sudo systemctl reload nginx
            
            # 7. Limpeza
            rm -rf /home/ubuntu/deploy-temp
            
            echo "=== FIM DO DEPLOY ==="